<div class="container mt-4">
    <c-card>
      <c-card-header>
        <strong>Old Leave Entry</strong>
      </c-card-header>
      <c-card-body>
        <form cForm #addLeaveForm="ngForm" (ngSubmit)="onSubmit()">
          <c-row>
            <c-col md="4">
              <c-input-group>
                <button cButton [disabled]="IsReadonly" type="button" color="secondary" (click)="openEmployeeModal()">
                  <svg [cIcon]="icons.cilSearch"></svg>
                </button>
                <input type="text"
                [readOnly]="IsReadonly"
                name="empCardNo" 
                #Pms = "ngModel"
                placeholder="Enter PMIS ID"
                [(ngModel)]="empCardNo" 
                cFormControl id="employeeId" 
                (input)="onEmpIdChange()"/>
              </c-input-group>
            </c-col>
          </c-row>
          <div class="d-flex justify-content-center text-center mt-2">
            <div>
              <h3>{{department}}</h3>
              <h4>Leave Application</h4>
            </div>
          </div>
          <c-row [gutter]="3" class="d-flex justify-content-around">
            <c-col md="3">
              <div class="p-4">
                <c-card>
                  <img [src]="employeePhoto" (error)="onImageError($event)" alt="Image Of Something" cCardImg="top">
                  <c-card-body>
                    <p>{{empCardNo}}</p>
                    <p cCardTitle>{{employeeName}}</p>
                    <p>{{designation}}</p>
  
                  </c-card-body>
                </c-card>
              </div>
              <div *ngIf="!IsReadonly" class="mt-4">
                <h5 class="mb-3">Leave Associate File Upload</h5>
                <input 
                multiple
                type="file"
                (change)="handleFile($event)"
                name="associatedFiles"
                cFormControl />
              </div>
              <div *ngIf="IsReadonly" class="mt-4" cListGroup>
                <h5>Leave Associated Files</h5>
                @for (file of leaveFiles; track $index) {
                  <a cListGroupItem target="_blank" [href]="baseImageUrl+'/leaveFile/'+file.filePath">
                    {{file.fileTitle}}
                    <!--<button (click)="test($event)" class="custom-button">
                      X
                    </button>-->
                  </a>
                }
              </div>
            </c-col>
            <c-col>
              <c-row class="mt-5 ms-md-5" [gutter]="3">
                <c-col md="6">
                    <label cLabel for="leaveType">Leave Type<span class="text-danger">*</span></label>
                    <select 
                    [disabled]="IsReadonly"
                    required
                    name="leaveTypeId"
                    #leaveType = "ngModel"
                    [(ngModel)]="this.addLeaveService.addLeaveModel.leaveTypeId"
                    #leavType = "ngModel"
                    cSelect 
                    cFormControl id="leaveType">
                      <option [ngValue]="null" selected>Select Leave Type</option>
                      @for (leaveType of LeaveTypeOption; track $index) {
                        <option [ngValue]="leaveType.id">{{leaveType.name}}</option>
                      }
                    </select>
                    @if (leaveType.invalid&&leaveType.touched) {
                      <div class="text-left text-danger">Leave Type is required</div>
                    }
                </c-col>
                <c-col [md]="6">
                  <label cLabel for="startDate">Start Date<span class="text-danger">*</span></label>
                  <input type="date" 
                  required
                  #startDate = "ngModel"
                  (change)="onDateChange()"
                  name="fromDate"
                  [(ngModel)]="this.addLeaveService.addLeaveModel.fromDate"
                  cFormControl id="startDate" />
                  @if(startDate.invalid && startDate.touched) {
                    <div class="text-left text-danger">Start Date is required</div>
                  }
                </c-col>
                <c-col [md]="6">
                  <label cLabel for="endDate">End Date<span class="text-danger">*</span></label>
                  <input type="date" 
                  required
                  (change)="onDateChange()"
                  name="toDate"
                  #endDate = "ngModel"
                  [(ngModel)]="this.addLeaveService.addLeaveModel.toDate"
                  cFormControl id="endDate" />
  
                  @if(endDate.invalid&&endDate.touched) {
                    <div class="text-left text-danger">End Date is required</div>
                  }
                </c-col>
                <c-col [md]="6">
                  <label cLabel for="totalLeaveDays">Total Leave</label>
                  <input type="text" 
                  readonly
                  [(ngModel)] = "totalLeave"
                  name="totalLeaveDays" 
                  cFormControl id="totalLeaveDays" />
                </c-col>
                <c-col [md]="6">
                  <label cLabel for="leavePurpose">Leave Purpose<span class="text-danger"></span></label>
                  <textarea type="text"
                  [readOnly]="IsReadonly"
                  rows="1"
                  #leavePurpose = "ngModel"
                  name="leavePurpose" 
                  [(ngModel)]="this.addLeaveService.addLeaveModel.leavePurpose"
                  cFormControl id="leavePurpose"></textarea>
  
                  @if(leavePurpose.invalid&&leavePurpose.touched) {
                    <div class="text-left text-danger">Leave Purpose is required</div>
                  }
                </c-col>
                <c-col [md]="6">
                  <label cLabel for="remarks">Remarks</label>
                  <input
                  [readOnly]="IsReadonly"
                  type="text" 
                  name="remark" 
                  [(ngModel)]="this.addLeaveService.addLeaveModel.remark"
                  cFormControl id="remarks" />
                </c-col>
              </c-row>
              <div class="mt-4 ms-md-5" cCollapse [visible]="addLeaveService.addLeaveModel.isForeignLeave">
                <h5 class="mb-3">Foreign Leave</h5>
                <c-row [gutter]="3">
                  <c-col [md]="6">
                    <label cLabel for="country">Country</label>
                    <select
                    [disabled]="IsReadonly" 
                    name="countryId"
                    [(ngModel)]="this.addLeaveService.addLeaveModel.countryId"
                    cSelect 
                    cFormControl id="country">
                      <option [ngValue]="null">Select Country</option>
                      @for (country of CountryOption; track $index) {
                        <option [ngValue]="country.id">{{country.name}}</option>
                      }
                    </select>
                  </c-col>
                  <c-col [md]="6">
                    <label cLabel for="purpose">Purpose</label>
                    <input type="text"
                    [readOnly]="IsReadonly"
                    name="foreignLeavePurpose"
                    [(ngModel)] = "this.addLeaveService.addLeaveModel.foreignLeavePurpose"
                    cFormControl id="purpose" />
                  </c-col>
                  <c-col [md]="6">
                    <label cLabel for="accompanyBy">Accompany by</label>
                    <input
                    [readOnly]="IsReadonly"
                    type="text" 
                    name="accompanyBy"
                    [(ngModel)]="this.addLeaveService.addLeaveModel.accompanyBy"
                    cFormControl 
                    id="accompanyBy" />
                  </c-col>
                </c-row>
              </div>
  
              <c-row class="mt-3 ms-md-5" [gutter]="3">
                <label cCol cLabel="col" sm="2">Reviewer: </label>
                <c-col md="4">
                  <c-input-group>
                    <button color="secondary"
                    [disabled]="IsReadonly"
                    (click)="openReviewerModal()"
                    type="button" 
                    cTooltip="Search Employee" 
                    cTooltipPlacement="bottom" cButton>
                      <svg [cIcon]="icons.cilSearch"></svg>
                    </button>
                    <input type="text" 
                    cFormControl
                    readonly
                    #reviewer = "ngModel"
                    [(ngModel)] = "reviewerName"
                    name="reviewedBy"
                    (input)="onReviewerChange()"
                    placeholder="Reviewer Name"
                    id="reviewedBy">
                  </c-input-group>
                </c-col>
                <c-col md="4">
                  <input type="text"
                  [readOnly]="IsReadonly"
                  [(ngModel)]="addLeaveService.addLeaveModel.reviewerRemark"
                  name="reviewerRemark" 
                  cFormControl
                  placeholder="Remark"
                  id="reviewerRemark">
                </c-col>
              </c-row>
              <c-row class="mt-3 ms-md-5 mb-3" [gutter]="3">
                <label cCol cLabel="col" sm="2">Approver: </label>
                <c-col md="4">
                  <c-input-group>
                    <button color="secondary" 
                    [disabled]="IsReadonly"
                    (click)="openApproverModal()"
                    type="button" 
                    cTooltip="Search Employee" 
                    cTooltipPlacement="bottom" cButton>
                      <svg [cIcon]="icons.cilSearch"></svg>
                    </button>
                    <input type="text"
                    readonly
                    [(ngModel)]="approverName"
                    placeholder="Approver Name"
                    cFormControl
                    name="approvedBy"
                    id="approvedBy">
                  </c-input-group>
                </c-col>
                <c-col md="4">
                  <input type="text"
                  [readOnly]="IsReadonly"
                  [(ngModel)]="addLeaveService.addLeaveModel.approverRemark"
                  name="reviewerRemark" 
                  cFormControl
                  placeholder="Remark"
                  id="reviewerRemark">
                </c-col>
              </c-row>
              <div class="mt-3 d-flex justify-content-end">
                <button 
                cButton 
                type="submit" 
                color="primary" 
                [disabled]="addLeaveForm.invalid||loading||!isValidPMS||(IsReadonly&&(leaveData.status!=leaveStatus.Pending))"
                class="me-2">
                <c-spinner [hidden]="loading == false" size="sm"></c-spinner>
                {{buttonTitle}}</button>
                <button *ngIf="!IsReadonly" cButton color="dark" (click)="onReset()">Cancel</button>
              </div>
          </c-col>
        </c-row>
        </form>
      </c-card-body>
    </c-card>
  </div>
    